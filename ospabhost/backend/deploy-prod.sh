#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è backend –Ω–∞ production
# –í—ã–ø–æ–ª–Ω—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/ospab-host/backend

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π backend..."

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backend
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backend..."
pm2 stop ospab-backend

# 2. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤..."
mkdir -p uploads/avatars

# 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client (—Å –Ω–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏)
echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma Client..."
npx prisma generate

# 4. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
echo "üíæ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –ë–î..."
npx prisma db push

# 5. –°–æ–±–∏—Ä–∞–µ–º TypeScript
echo "üî® –°–æ–±–∏—Ä–∞–µ–º TypeScript..."
npm run build

# 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend
echo "‚ñ∂Ô∏è  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend..."
pm2 restart ospab-backend1

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
pm2 status ospab-backend1

echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
echo ""
echo "üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs ospab-backend"
echo "üîç –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ: pm2 logs ospab-backend --err"
